<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.jetsetgo.dbio.MyPageMapper">

    <!-- 사용자 로그인 ID로 검색 -->
    <select id="findUserInfoByUserName" resultType="kr.co.jetsetgo.model.TbMembersDto">
        SELECT * FROM MEMBERS WHERE USERNAME = #{userName}
    </select>

    <!-- 사용자 정보  수정 -->
    <update id="editUserInfo">
        UPDATE MEMBERS SET PHONENUMBER = #{contact} WHERE USERNAME = #{id}
    </update>

    <!-- 사용자 비밀번호 수정 -->
    <update id="editUserPassword">
        UPDATE MEMBERS SET PASSWORD = #{password} WHERE USERNAME = #{id}
    </update>

    <!-- 사용자  삭제 -->
    <delete id="removeUser">
        DELETE FROM MEMBERS WHERE USERNAME = #{id}
    </delete>

    <!-- 예약 검색 -->
    <select id="findReservationByUserId" resultType="kr.co.jetsetgo.model.ReservationDto">
        SELECT
            r.MEMBER_ID,
            r.RESERVATION_ID,
            r.RESERVATION_DATE,
            rf.RESERVATION_FLIGHTS_ID,
            r.STATUS,
            f.ID,
            f.ORIGINLOCATIONCODE,
            f.DESTINATIONLOCATIONCODE,
            f.DEPARTURE_CITY,
            f.ARRIVAL_CITY,
            f.DEPARTURE_TIME,
            f.ARRIVAL_TIME
        FROM
            RESERVATION r
                JOIN
            RESERVATION_FLIGHTS rf ON r.RESERVATION_ID = rf.RESERVATION_ID
                JOIN
            FLIGHTS f ON rf.FLIGHT_ID = f.ID
        WHERE
            r.MEMBER_ID = #{userId}
          AND
                f.DEPARTURE_TIME = (
                SELECT MIN(f2.DEPARTURE_TIME)
                FROM FLIGHTS f2
                         JOIN RESERVATION_FLIGHTS rf2 ON f2.ID = rf2.FLIGHT_ID
                WHERE rf2.RESERVATION_ID = r.RESERVATION_ID
            )
        ORDER BY
            r.RESERVATION_DATE DESC;
    </select>

</mapper>